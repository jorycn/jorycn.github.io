<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Laravel5新特性 - Events & Handlers · 小白巷</title><meta name="description" content="事件是系统开发中非常重要的一部分，可以在一次编码后只需修改事件规则，无需更改流程代码。比如商城站，用户在登陆之后，系统会做两件事情：

给新用户发送站内信，欢迎新用户；
发送欢迎邮件；如果按照原始的程序，会在注册完成之后触发一系列动作函数。但如果后期站内除了折扣码，我们不得不修改核心流程，添加折扣码处理函数。每添加一个动作必须修改核心流程，显然不符合最佳代码规范,我们可以将用户注册完成之后触发的一系列动作封装起来，于是便出现了事件。laravel4中已经有了事件的概念，不过目录文件并没有默认创建，需要我们自己创建，再在composer配置文件中新加事件目录即可，具体操作大家可以查看laravel4官方文档。Laravel4中事件的触发依赖事件的名称：$response = Event::fire(‘auth.login’, array($user));而Laravel5则不再使用这种方式，通常直接new一个php对象;我们直接上栗子：

&lt;h3 id=&quot;u7B"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">博客</a></li><li class="nav-list-item"><a href="http://weibo.com/jorycn" target="_blank" class="nav-list-link">微博</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><li class="nav-list-item"><a href="https://github.com/jorycn" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Laravel5新特性 - Events & Handlers</h1><div class="post-meta"><div class="post-time">2015年4月21日</div></div><div class="post-content"><p>事件是系统开发中非常重要的一部分，可以在一次编码后只需修改事件规则，无需更改流程代码。比如商城站，用户在登陆之后，系统会做两件事情：</p>
<ol>
<li>给新用户发送站内信，欢迎新用户；</li>
<li>发送欢迎邮件；<br>如果按照原始的程序，会在注册完成之后触发一系列动作函数。但如果后期站内除了折扣码，我们不得不修改核心流程，添加折扣码处理函数。每添加一个动作必须修改核心流程，显然不符合最佳代码规范,我们可以将用户注册完成之后触发的一系列动作封装起来，于是便出现了事件。<br>laravel4中已经有了事件的概念，不过目录文件并没有默认创建，需要我们自己创建，再在composer配置文件中新加事件目录即可，具体操作大家可以查看laravel4官方文档。<br>Laravel4中事件的触发依赖事件的名称：<br><div class="linenums"><br><div class="L0"><br><pre class="lang:php decode:true">$response = Event::fire(‘auth.login’, array($user));</pre><br></div><br></div><br>而Laravel5则不再使用这种方式，通常直接new一个php对象;<br>我们直接上栗子：</li>
</ol>
<h3 id="u7B2C_u4E00_u6B65_uFF1A_u4F7F_u7528_u547D_u4EE4_u65B0_u5EFAEvent"><a href="#u7B2C_u4E00_u6B65_uFF1A_u4F7F_u7528_u547D_u4EE4_u65B0_u5EFAEvent" class="headerlink" title="第一步：使用命令新建Event"></a>第一步：使用命令新建Event</h3><div class="linenums"><br><div class="L0"><br><pre class="lang:php decode:true">php artisan make:event CacheEvent</pre><br></div><br></div><br>将会创建如下Event：<br><div class="linenums"><br><div class="L0"><br><pre class="lang:php decode:true">&lt;?php namespace App\Events;<br><br>use App\Events\Event;<br>use Illuminate\Queue\SerializesModels;<br><br>class CacheEvent extends Event {<br>use SerializesModels;<br><br>/<em>*
</em> Create a new event instance.<br><em>
</em> @return void<br>*/<br>public function __construct()<br>{<br>//<br>}<br><br>}</pre><br></div><br></div>

<h3 id="u7B2C_u4E8C_u6B65_uFF1A_u4F7F_u7528_u547D_u4EE4_u65B0_u5EFAHandler"><a href="#u7B2C_u4E8C_u6B65_uFF1A_u4F7F_u7528_u547D_u4EE4_u65B0_u5EFAHandler" class="headerlink" title="第二步：使用命令新建Handler"></a>第二步：使用命令新建Handler</h3><div class="linenums"><br><div class="L0"><code>&lt;span class=&quot;pln&quot;&gt;php artisan handler&lt;/span&gt;&lt;span class=&quot;pun&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;kwd&quot;&gt;event&lt;/span&gt; &lt;span class=&quot;typ&quot;&gt;CacheRouteHandler&lt;/span&gt; &lt;span class=&quot;pun&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;kwd&quot;&gt;event&lt;/span&gt;&lt;span class=&quot;pun&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;str&quot;&gt;&quot;CacheEvent&quot;&lt;/span&gt;</code></div><br></div><br>将会创建以下Handler<br><div class="linenums"><br><div class="L0"><br><pre class="lang:php decode:true ">&lt;?php namespace App\Handlers\Events;<br><br>use App\Events\CacheEvent;<br><br>use Illuminate\Queue\InteractsWithQueue;<br>use Illuminate\Contracts\Queue\ShouldBeQueued;<br><br>class CacheRouteHandler {<br>/<strong><br><em> Create the event handler.
</em><br><em> @return void
</em>/<br>public function __construct()<br>{<br>//<br>}<br><br>/</strong><br><em> Handle the event.
</em><br><em> @param ThingWasDone $event
</em> @return void<br>*/<br>    public function handle(CacheEvent $event)<br>{<br>//初始化一些必要的缓存<br>}<br><br>}</pre><br></div><br></div><br>大家发现自动生成event已经做好了方法注入，当然你也可以在construct函数里面注入绑定，然后在定义全局对象即可；<br><br>### 第三步：绑定Event和Handler<br><br>ok，创建好了event和Handler，我们还需要将它们绑定起来。文件在<code>app\Providers\EventServiceProvider</code>:<br><div class="linenums"><br><div class="L0"><br><pre class="lang:php decode:true ">// app\Providers\EventServiceProvider<br>protected $listen = [<br>‘App\Events\CacheEvent’ =&gt; [<br>‘App\Handlers\Events\CacheRouteHandler’,<br>…<br>],<br>];</pre><br></div><br></div>

<h3 id="u7B2C_u56DB_u6B65_uFF1AFire"><a href="#u7B2C_u56DB_u6B65_uFF1AFire" class="headerlink" title="第四步：Fire"></a>第四步：Fire</h3><div class="linenums"><br><div class="L0"><br><pre class="lang:php decode:true">\Event::fire(new App\Events\CacheEvent());</pre><br></div><br></div><br>ok，截止目前，我们已经会使用了laravel5中的事件。当然，事件也是可以绑定参数的，网上找到一个参数传递的栗子，大家可以参考下：<br><div class="linenums"><br><div class="L0"><br><pre class="lang:php decode:true">class SidebarEvent {<br><br>public $first;<br>public $second;<br>public $third;<br><br>public function __construct($first, $second, $third) {<br>    $this-&gt;first = $first;<br>    $this-&gt;second = $second;<br>    $this-&gt;third = $third;<br>}<br><br>public function getData()<br>{<br>return [<br>   ‘first’ =&gt; $this-&gt;first,<br>   ‘second’ =&gt; $this-&gt;second,<br>   ‘third’ =&gt; $this-&gt;third,<br>];<br>}<br>}</pre><br></div><br></div><br>获取参数<br><div class="linenums"><br><div class="L0"><br><pre class="lang:php decode:true ">class SidebarNavigationListener<br>{<br>public function handle(SidebarEvent $event)<br>{<br>   dd($event-&gt;getData());<br>}<br>}</pre><br></div><br></div><br>使用参数<br><div class="linenums"><br><div class="L0"><br><pre class="lang:php decode:true">Event::fire(new SidebarEvent(‘1’, ‘2’, ‘3’));</pre><br></div><br></div></div></article></div></section><footer><div class="paginator"><a href="/2015/04/21/the-worst-10-ghost-stories/" class="prev">上一篇</a><a href="/2015/04/16/laravel5-hander-exception/" class="next">下一篇</a></div></footer><script src="https://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>