<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 微信分享封装 · xbhub</title><meta name="description" content="很久没有更新了，最近有些忙，等有机会会专门做些系列文章，感谢大家支持！大家在开发微信h5页面或者专题的时候，往往需要后台获取signature，很难脱离后台的支持。这里，就教大家如何将微信分享封装起来，整个过程一旦做好后台接口之后，不再需要后台程序介入！
WXJssdkInit=function(options){    if(!options)options={};    var jssdk=’http://res.wx.qq.com/open/js/jweixin-1.0.0.js&amp;#39;;//微信的sdk    var jssdkGetSignature=”http://www.xbhub.com/api/getSi"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/blog/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">博客</a></li><li class="nav-list-item"><a href="http://weibo.com/jorycn" target="_blank" class="nav-list-link">微博</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><li class="nav-list-item"><a href="https://github.com/jorycn" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">微信分享封装</h1><div class="post-meta"><div class="post-time">2015年9月5日</div></div><div class="post-content"><p>很久没有更新了，最近有些忙，等有机会会专门做些系列文章，感谢大家支持！<br>大家在开发微信h5页面或者专题的时候，往往需要后台获取signature，很难脱离后台的支持。这里，就教大家如何将微信分享封装起来，整个过程一旦做好后台接口之后，不再需要后台程序介入！</p>
<p><pre class="lang:js decode:true">WXJssdkInit=function(options){<br>    if(!options)options={};<br>    var jssdk=’<a href="http://res.wx.qq.com/open/js/jweixin-1.0.0.js&#39;;//微信的sdk" target="_blank" rel="external">http://res.wx.qq.com/open/js/jweixin-1.0.0.js&#39;;//微信的sdk</a><br>    var jssdkGetSignature=”<a href="http://www.xbhub.com/api/getSign&quot;//获取jssdk签名接口包含参数sServiceType=feiji和sUrl" target="_blank" rel="external">http://www.xbhub.com/api/getSign&quot;//获取jssdk签名接口包含参数sServiceType=feiji和sUrl</a><br>    var jssdkGetSignatureCharset=’utf-8’//获取jssdk签名接口编码<br>    var scriptLoader = function(){<br>        var firstScript = document.getElementsByTagName(‘script’)[0];<br>        var scriptHead = firstScript.parentNode;<br>        var re = /ded|co/;<br>        var onload = ‘onload’;<br>        var onreadystatechange = ‘onreadystatechange’;<br>        var readyState = ‘readyState’;<br>        var load = function(src, fn, charset){<br>          var script = document.createElement(‘script’);<br>          script.charset = charset;<br>          script[onload] = script[onreadystatechange] = function(){<br>            if(!this[readyState] || re.test(this[readyState])){<br>              script[onload] = script[onreadystatechange] = null;<br>              fn &amp;&amp; fn(script);<br>              script = null;<br>            }<br>          };<br>          script.async = true;<br>          script.src = src;<br>          scriptHead.insertBefore(script, firstScript);<br>        };<br>        return function(srces, fn, charset){<br>          charset = charset || ‘gb2312’;<br>          if(typeof srces == ‘string’){<br>            load(srces, fn, charset);<br>          }else{<br>            var src = srces.shift();<br>            load(src, function(){<br>              if(srces.length){<br>                scriptLoader(srces, fn, charset);<br>              } else {<br>                fn &amp;&amp; fn();<br>              }<br>            }, charset);<br>          }<br>        };<br>    }();<br>    var xhrFactory = function () {<br>        this.init.apply(this, arguments);<br>    }<br>    xhrFactory.prototype = {<br>        init: function () {<br>            this.xhr = this.create();<br>        },<br>        create: function () {<br>            var xhr = null;<br>            try {<br>                if (window.XMLHttpRequest) {<br>                    xhr = new XMLHttpRequest();<br>                }<br>                else if (window.ActiveXObject) {<br>                    xhr = new ActiveXObject(“Msxml2.Xmlhttp”);<br>                }<br>            }<br>            catch (err) {<br>                xhr = new ActiveXObject(“Microsoft.Xmlhttp”);<br>            }<br>            return xhr;<br>        },<br>        readystate: function (timeout,callback) {<br>            var self=this;<br>            self.xhr.onreadystatechange = function () {<br>                if (this.readyState == 4 &amp;&amp; this.status == 200) {<br>                    callback(eval(“(“ + this.responseText + “)”));<br>                }<br>                else {<br>                    setTimeout(function () {<br>                        self.xhr.abort();<br>                    }, !timeout ? 15000 : timeout);<br>                }<br>            }<br>        },<br>        para: function (data) {<br>            return data;<br>        },<br>        get: function (url, data, callback, async, timeout) {<br>            this.readystate(timeout, callback);<br>            var newurl = url;<br>            var datastr = this.para(data);<br>            newurl = url + “?” + datastr;<br>            this.xhr.open(“get”, newurl, !async ? true : async);<br>            this.xhr.send(null);<br>        },<br>        post: function (url, data, callback, async, timeout) {<br>            this.readystate(timeout, callback);<br>            var newurl = url;<br>            var datastr = this.para(data);<br>            this.xhr.open(“post”, newurl, !async ? true : async);<br>            this.xhr.setRequestHeader(“content-type”, “x-www-form-urlencoded”);<br>            this.xhr.send(!datastr ? null : datastr);<br>        }<br>    }<br>    /<em><br>      fn为回调方法，传递wx对象<br>      appId 可选,为相应公众号appid,留空会根据页面url寻找<br>      jsApiList可选,为api功能接口，留空取得全部,<br>      ifDebug可选,为是否进行调试，留空不进行调试
    </em>/<br>    this.init=function(fn,appId,jsApiList,ifDebug){<br>        scriptLoader(jssdk,function(){<br>            if(options.sServiceType){<br>                var sServiceType=options.sServiceType;<br>            }else{<br>                var r=/https?:\/\/([\s\S]+?)./.exec(location.href);<br>                if(r&amp;&amp;r[1]){<br>                    var sServiceType=r[1];<br>                }<br>                else{<br>                    if(ifDebug){<br>                        console.log(‘Not support local test,please use url start with ‘http//’.’);<br>                        alert(‘Not support local test,please use url start with ‘http//’.’);<br>                    }<br>                    return;<br>                }<br>            }<br>            var  xhr = new xhrFactory();<br>            xhr.get(jssdkGetSignature, ‘sServiceType=’+sServiceType+’&amp;sUrl=’+(location.href.replace(/[#][\s\S]*/,’’))+((appId)?(‘&amp;sAppId=’+appId):’’), function (data) {<br>                if(data.iRet!=’-1’){<br>                    //获取签名<br>                    var signature=data.jData.signature;<br>                    if(!jsApiList){<br>                        jsApiList=[<br>                            ‘checkJsApi’,<br>                            ‘onMenuShareTimeline’,<br>                            ‘onMenuShareAppMessage’,<br>                            ‘onMenuShareQQ’,<br>                            ‘onMenuShareWeibo’,<br>                            ‘hideMenuItems’,<br>                            ‘showMenuItems’,<br>                            ‘hideAllNonBaseMenuItem’,<br>                            ‘showAllNonBaseMenuItem’,<br>                            ‘translateVoice’,<br>                            ‘startRecord’,<br>                            ‘stopRecord’,<br>                            ‘onRecordEnd’,<br>                            ‘playVoice’,<br>                            ‘pauseVoice’,<br>                            ‘stopVoice’,<br>                            ‘uploadVoice’,<br>                            ‘downloadVoice’,<br>                            ‘chooseImage’,<br>                            ‘previewImage’,<br>                            ‘uploadImage’,<br>                            ‘downloadImage’,<br>                            ‘getNetworkType’,<br>                            ‘openLocation’,<br>                            ‘getLocation’,<br>                            ‘hideOptionMenu’,<br>                            ‘showOptionMenu’,<br>                            ‘closeWindow’,<br>                            ‘scanQRCode’,<br>                            ‘chooseWXPay’,<br>                            ‘openProductSpecificView’,<br>                            ‘addCard’,<br>                            ‘chooseCard’,<br>                            ‘openCard’<br>                        ];<br>                    }<br>                    var ops={<br>                        debug: ifDebug, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。<br>                        appId: data.jData.appId, // 必填，公众号的唯一标识<br>                        timestamp:data.jData.timestamp , // 必填，生成签名的时间戳<br>                        nonceStr: data.jData.nonceStr, // 必填，生成签名的随机串<br>                        signature: data.jData.signature,// 必填，签名，见附录1<br>                        jsApiList: jsApiList // 必填，需要使用的JS接口列表，所有JS接口列表见附录2<br>                    };<br>                    wx.config(ops);<br>                    wx.ready(function() {<br>                        fn(wx);<br>                    });<br>                }else{<br>                    if(ifDebug){<br>                        console.log(‘Signature ajax error.’);<br>                        alert(‘Signature ajax error.’);<br>                    }<br>                }<br>            });<br>        },jssdkGetSignatureCharset);<br>    }<br>}<br>WXJssdk=new WXJssdkInit();</pre><br>大家只需将以上jssdkGetSignature接口地址改成自己的地址就行了，会发送get请求，具体实现大家可以看源码。请求过程会有两个参数url和appid，url是当前路由是获取signature必须的参数，appid则是看大家自己需求了，是否需要主要看两点：<br>1： 是否需要业务分离；<br>2：业务分散在多个域名上（一个公众号只能绑定三个可信任域名）；<br>注意返回的数据格式与下面ops参数一致。还有，不要忘了去公众号开启信任。哈哈~~以后需要接入的地方都需要添加信任域名，不要忘记了。</p>
<p><strong>使用</strong></p>
<p><pre class="lang:php decode:true">&lt;script src=”<a href="http://www.xbhub.com/js/WXJssdk.js&quot;&gt;&lt;/script&amp;gt" target="_blank" rel="external">http://www.xbhub.com/js/WXJssdk.js&quot;&gt;&lt;/script&amp;gt</a>;<br>&lt;script&gt;<br>WXJssdk.init(function(wx){<br>    //只是一个h5选择器而已<br>    document.querySelector(‘#checkJsApi’).onclick = function() {<br>        //在此可以使用所有微信JSSDK接口方法<br>        wx.checkJsApi({<br>            jsApiList: [‘getNetworkType’, ‘previewImage’,’chooseImage’],<br>            success: function(res) {<br>                alert(JSON.stringify(res));<br>            }<br>        });<br>    };<br>})</pre><br>哈哈~如此，是不是感觉春分拂面，爽歪歪。<br>web组件化必将是未来开发趋势，我也在不断的努力之中。</p>
</div></article></div></section><footer><div class="paginator"><a href="/blog/2015/10/16/lanmp-apache/" class="prev">上一篇</a><a href="/blog/2015/07/23/give-it-five-minutes/" class="next">下一篇</a></div></footer><script src="https://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>